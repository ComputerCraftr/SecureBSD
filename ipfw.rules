#!/bin/sh

# Exit on errors and undefined variables
set -eu

# Define the firewall command
fwcmd="/sbin/ipfw"

# Rule number map
# 100–160: loopback, fail2ban, fragments, shaping, NAT, Suricata, check-state
# 170–189: ICMP flood + loopback/IPv6 hygiene
# 200–207: VPN leak prevention + VPN endpoints/DNS
# 220–234: IP options + DHCP
# 240–244: outbound allow
# 250–263: anti-spoof + ICMP allow/deny
# 270–279: multicast/martians
# 300–316: inbound services (v4/v6)
# 320–323: inbound to me + internal pass
# 390: final deny

# Define interfaces and ports
nat_if=""            # Adjust as needed for your external interface
tun_if=""            # Adjust as needed for your tunnel interface
int_if=""            # Adjust as needed for your internal (bridge) interface
vpn_endpoints_ip4="" # List of allowed VPN endpoints/proxies
vpn_tcp_port=""      # VPN TCP port to allow outbound
vpn_udp_port=""      # VPN UDP port to allow outbound
vpn_dns_ip4="\
9.9.9.9,\
149.112.112.112,\
1.1.1.2,\
1.0.0.2"                # List of allowed VPN setup DNS servers
suricata_divert_port="" # Suricata divert port for inline IPS (set when Suricata is enabled)
ssh_ip4=""              # List of allowed SSH source IPv4 addresses
ssh_ip6=""              # List of allowed SSH source IPv6 addresses
ssh_tcp_port=""         # SSH TCP port to allow
dhcp_ip4=""             # List of allowed DHCP server IPv4 addresses
lan_tcp_ports=""        # LAN TCP ports to allow
lan_udp_ports=""        # LAN UDP ports to allow
wan_tcp_ports=""        # User TCP ports to allow
wan_udp_ports=""        # User UDP ports to allow
pipe_tcp_ports=""       # TCP ports to limit bandwidth (defaults to wan_tcp_ports)
pipe_udp_ports=""       # UDP ports to limit bandwidth (defaults to wan_udp_ports)
nat_if_in_bw=""         # Inbound shaping on nat_if (e.g. 20Mbit/s)
nat_if_out_bw=""        # Outbound shaping on nat_if (e.g. 10Mbit/s)
log_default_deny="yes"  # Whether to log the default deny rules

# Define martian (and multicast) IP ranges to deny
martians_ip4="0.0.0.0/8,\
127.0.0.0/8,\
192.0.2.0/24,\
192.88.99.0/24,\
198.18.0.0/15,\
198.51.100.0/24,\
203.0.113.0/24,\
204.152.64.0/23,\
233.252.0.0/24,\
240.0.0.0/4,\
255.255.255.255/32"
martians_ip6="::/128,\
::1/128,\
100::/64,\
2001::/32,\
2001:20::/28"
martians_ip6_2="2001:db8::/32,\
2002::/16,\
3fff::/20,\
5f00::/16"
multicast_ip4="224.0.0.0/4"
multicast_ip6="ff00::/8"

# Allow environment variable overrides (upper-case only).
for var in \
    nat_if tun_if int_if vpn_endpoints_ip4 vpn_tcp_port vpn_udp_port vpn_dns_ip4 \
    suricata_divert_port ssh_ip4 ssh_ip6 ssh_tcp_port dhcp_ip4 \
    lan_tcp_ports lan_udp_ports wan_tcp_ports wan_udp_ports \
    pipe_tcp_ports pipe_udp_ports nat_if_in_bw nat_if_out_bw log_default_deny \
    martians_ip4 martians_ip6 martians_ip6_2 multicast_ip4 multicast_ip6; do
    upper=$(printf "%s" "$var" | tr '[:lower:]' '[:upper:]')
    eval "override=\${$upper-}"
    if [ -n "$override" ]; then
        eval "$var=\$$upper"
    fi
done
if [ -z "${pipe_tcp_ports:-}" ]; then
    pipe_tcp_ports="$wan_tcp_ports"
fi
if [ -z "${pipe_udp_ports:-}" ]; then
    pipe_udp_ports="$wan_udp_ports"
fi

# Check if IPv6 is available by detecting any IPv6 addresses
ipv6_available=$(ifconfig | grep -qwF "inet6" && echo 1 || echo 0)

# Check if each interface is available
nat_if_available=$([ -n "${nat_if:-}" ] && [ "$nat_if" != "none" ] && ifconfig "$nat_if" >/dev/null 2>&1 && echo 1 || echo 0)
tun_if_available=$([ -n "${tun_if:-}" ] && [ "$tun_if" != "none" ] && ifconfig "$tun_if" >/dev/null 2>&1 && echo 1 || echo 0)
if [ "$nat_if_available" -eq 1 ] && [ "$tun_if_available" -ne 1 ]; then
    tun_if="$nat_if"
    tun_if_available="$nat_if_available"
fi
int_if_available=$([ -n "${int_if:-}" ] && [ "$int_if" != "none" ] && ifconfig "$int_if" >/dev/null 2>&1 && echo 1 || echo 0)

# Flush existing rules
${fwcmd} -q flush
${fwcmd} -q pipe flush
${fwcmd} -q queue flush
${fwcmd} -q sched flush

# Define NAT instance
if [ "$int_if_available" -eq 1 ] && [ "$nat_if_available" -eq 1 ]; then
    ${fwcmd} nat 1 config if "$nat_if" same_ports unreg_only reset
fi

#################################
# Loopback Traffic Handling
#################################
# Allow all traffic on the loopback interface (lo0)
${fwcmd} add 100 allow ip from any to any via lo0

#################################
# IPFW Table Handling
#################################
# Deny traffic from Fail2Ban table
${fwcmd} table fail2ban create or-flush type addr
${fwcmd} add 110 deny log ip from 'table(fail2ban)' to any

#################################
# Fragmented Packet Handling
#################################
# Deny fragmented IPv4 packets
${fwcmd} add 120 deny ip4 from any to any frag mf

#################################
# Network Traffic Shaping
#################################
# Limit user connection bandwidth
if { [ -n "${pipe_tcp_ports:-}" ] && [ "$pipe_tcp_ports" != "none" ]; } ||
    { [ -n "${pipe_udp_ports:-}" ] && [ "$pipe_udp_ports" != "none" ]; }; then
    pipe_ports=$(echo "$pipe_tcp_ports,$pipe_udp_ports" | sed -E 's/^,+//;s/,+$//')
    ${fwcmd} pipe 1 config bw 1Mbit/s buckets 2048 mask src-ip 0xffffffff dst-ip 0xffffffff type fq_codel target 5ms quantum 6000 flows 2048 interval 400
    ${fwcmd} add 130 pipe 1 ip4 from any to me "$pipe_ports" in
    ${fwcmd} add 131 pipe 1 ip4 from me "$pipe_ports" to any out
    if [ "$ipv6_available" -eq 1 ]; then
        ${fwcmd} pipe 2 config bw 1Mbit/s buckets 2048 mask src-ip6 60 dst-ip6 60 type fq_codel target 5ms quantum 6000 flows 2048 interval 400
        ${fwcmd} add 132 pipe 2 ip6 from any to me6 "$pipe_ports" in
        ${fwcmd} add 133 pipe 2 ip6 from me6 "$pipe_ports" to any out
    fi
fi

# Shape all traffic on the NAT interface (in/out) using fq_codel
if [ "$nat_if_available" -eq 1 ]; then
    if [ -n "${nat_if_in_bw:-}" ] && [ "$nat_if_in_bw" != "none" ]; then
        ${fwcmd} pipe 3 config bw "$nat_if_in_bw" type fq_codel target 5ms quantum 6000 flows 2048 interval 400
        ${fwcmd} queue 3 config pipe 3
        ${fwcmd} add 134 queue 3 ip from any to any in recv "$nat_if"
    fi
    if [ -n "${nat_if_out_bw:-}" ] && [ "$nat_if_out_bw" != "none" ]; then
        ${fwcmd} pipe 4 config bw "$nat_if_out_bw" type fq_codel target 5ms quantum 6000 flows 2048 interval 400
        ${fwcmd} queue 4 config pipe 4
        ${fwcmd} add 135 queue 4 ip from any to any out xmit "$nat_if"
    fi
fi

# Dummynet pipe to limit ICMPv4/ICMPv6 bandwidth
${fwcmd} pipe 5 config bw 100Kbit/s type qfq

#################################
# IPv4 NAT Traffic Handling
#################################
# NAT traffic from the tunnel/external interface to the internal interface
if [ "$int_if_available" -eq 1 ] && [ "$nat_if_available" -eq 1 ]; then
    ${fwcmd} add 140 nat 1 ip4 from any to any via "$nat_if"
fi

#################################
# Suricata Traffic Diversion
#################################
# Divert inbound traffic on the NAT interface to Suricata for inline IPS processing
if [ "$nat_if_available" -eq 1 ] && [ -n "${suricata_divert_port:-}" ] && [ "$suricata_divert_port" != "none" ]; then
    ${fwcmd} add 150 divert "$suricata_divert_port" ip from any to any not proto icmp not proto ipv6-icmp in recv "$nat_if"
fi

#################################
# Stateful Traffic Handling
#################################
# Check the state of all connections to allow established connections
${fwcmd} add 160 check-state

#################################
# ICMP Flood Protection
#################################
# Don't throttle the internal bridge interface (if available)
if [ "$int_if_available" -eq 1 ]; then
    # Limit ICMPv4 echo requests and replies (ping flood protection)
    ${fwcmd} add 170 pipe 5 icmp from any to me icmptypes 8,0 in not recv "$int_if"

    # IPv6 ICMPv6 echo requests and replies (ping flood protection)
    if [ "$ipv6_available" -eq 1 ]; then
        ${fwcmd} add 171 pipe 5 ipv6-icmp from any to me6 icmp6types 128,129 in not recv "$int_if"
    fi
else
    # Limit ICMPv4 echo requests and replies (ping flood protection)
    ${fwcmd} add 170 pipe 5 icmp from any to me icmptypes 8,0 in

    # IPv6 ICMPv6 echo requests and replies (ping flood protection)
    if [ "$ipv6_available" -eq 1 ]; then
        ${fwcmd} add 171 pipe 5 ipv6-icmp from any to me6 icmp6types 128,129 in
    fi
fi

#################################
# Loopback Protection and IPv6 Network Functionality
#################################
# Deny traffic to and from the IPv4 loopback network (127.0.0.0/8)
${fwcmd} add 180 deny ip from any to 127.0.0.0/8
${fwcmd} add 181 deny ip from 127.0.0.0/8 to any

# IPv6 loopback and network functionality rules (if IPv6 is available)
if [ "$ipv6_available" -eq 1 ]; then
    # Deny traffic to and from the IPv6 loopback address (::1/128)
    ${fwcmd} add 182 deny ip from any to ::1/128
    ${fwcmd} add 183 deny ip from ::1/128 to any

    # Deny routing header type 0 (RH0) to prevent amplification and redirection attacks (RFC5095)
    ${fwcmd} add 184 deny log ip6 from any to any ext6hdr rthdr0

    # Deny fragmented ICMPv6 Neighbor Discovery Protocol (NDP) packets to prevent DoS attacks (RFC6980)
    ${fwcmd} add 185 deny log ipv6-icmp from any to any ext6hdr frag icmp6types 130,131,132,133,134,135,136,137,138,141,142,143

    # Deny all fragmented packets going to link-local or multicast scope — protects against ND and MLD evasion
    ${fwcmd} add 186 deny log ipv6-icmp from any to "fe80::/10,ff00::/8" ext6hdr frag

    # Deny MLDv1 listener report and listener done packets
    ${fwcmd} add 187 deny ipv6-icmp from any to any icmp6types 131,132

    # Allow ICMPv6 Neighbor Solicitation (NS) and Neighbor Advertisement (NA) for address resolution (unicast, link-local, and multicast)
    ${fwcmd} add 188 allow ipv6-icmp from any to any icmp6types 135,136

    # Allow ICMPv6 Duplicate Address Detection (DAD), Router Solicitation (RS), Router Advertisement (RA),
    # Neighbor Solicitation (NS), and Neighbor Advertisement (NA) for link-local traffic
    ${fwcmd} add 189 allow ipv6-icmp from "::/128,fe80::/10" to "fe80::/10,ff02::/16"
fi

#################################
# VPN LAN Leak Prevention
#################################
# Deny traffic between the external interface and the internal interface
if [ "$int_if_available" -eq 1 ] && [ "$tun_if_available" -eq 1 ]; then
    if [ "$nat_if_available" -eq 1 ]; then
        ${fwcmd} add 200 deny ip from any to any out recv "$int_if" not xmit "$tun_if" not xmit "$nat_if"
        ${fwcmd} add 201 deny ip from any to any out recv not recv "$tun_if" not recv "$nat_if" xmit "$int_if"
    else
        ${fwcmd} add 200 deny ip from any to any out recv "$int_if" not xmit "$tun_if"
        ${fwcmd} add 201 deny ip from any to any out recv not recv "$tun_if" xmit "$int_if"
    fi

    # Allow outbound traffic to the VPN endpoints/proxies
    if [ -n "${vpn_endpoints_ip4:-}" ] && [ "$vpn_endpoints_ip4" != "none" ]; then
        ${fwcmd} add 203 allow icmp from me to "$vpn_endpoints_ip4" icmptypes 8 out record-state
        ${fwcmd} add 204 allow icmp from me to "$vpn_endpoints_ip4" out
        if [ -n "${vpn_tcp_port:-}" ] && [ "$vpn_tcp_port" != "none" ]; then
            ${fwcmd} add 205 allow ip4 from me to "$vpn_endpoints_ip4" "$vpn_tcp_port" tcpflags syn,!ack,!fin,!rst out record-state
        fi
        if [ -n "${vpn_udp_port:-}" ] && [ "$vpn_udp_port" != "none" ]; then
            ${fwcmd} add 206 allow ip4 from me to "$vpn_endpoints_ip4" "$vpn_udp_port" proto udp out record-state
        fi
    fi

    # Allow outbound traffic to the VPN setup DNS servers
    if [ -n "${vpn_dns_ip4:-}" ] && [ "$vpn_dns_ip4" != "none" ]; then
        ${fwcmd} add 207 allow ip4 from me to "$vpn_dns_ip4" 53 out record-state
    fi
fi

#################################
# Anti-DoS and Recon Prevention
#################################
# Block packets with IP options
${fwcmd} add 220 deny log ip from any to any ipoptions ssrr in
${fwcmd} add 221 deny log ip from any to any ipoptions lsrr in
${fwcmd} add 222 deny log ip from any to any ipoptions rr in
${fwcmd} add 223 deny log ip from any to any ipoptions ts in

#################################
# DHCP and Broadcast Traffic
#################################
# Allow DHCPv4 traffic (outbound/inbound)
if [ "$dhcp_ip4" = "any" ]; then
    ${fwcmd} add 230 allow ip4 from any 68 to any 67 proto udp
    ${fwcmd} add 231 allow ip4 from any 67 to any 68 proto udp
elif [ -n "${dhcp_ip4:-}" ] && [ "$dhcp_ip4" != "none" ]; then
    ${fwcmd} add 230 allow ip4 from any 68 to \{ "$dhcp_ip4" or 255.255.255.255 \} 67 proto udp
    ${fwcmd} add 231 allow ip4 from "$dhcp_ip4" 67 to any 68 proto udp
else
    ${fwcmd} add 230 allow ip4 from me 68 to any 67 proto udp out
    ${fwcmd} add 231 allow ip4 from any 67 to any 68 proto udp in
fi
${fwcmd} add 232 deny log ip4 from any to any 67,68 proto udp

# Allow DHCPv6 traffic (if IPv6 is available)
if [ "$ipv6_available" -eq 1 ]; then
    ${fwcmd} add 233 allow ip6 from fe80::/10 546 to ff02::1:2 547 proto udp
    ${fwcmd} add 234 allow ip6 from fe80::/10 547 to fe80::/10 546 proto udp
fi

#################################
# Outbound Traffic
#################################
# Limit outbound traffic if the VPN is active
if [ "$int_if_available" -eq 1 ] && [ "$tun_if_available" -eq 1 ] && [ "$nat_if_available" -eq 1 ]; then
    # Allow all ICMPv4 outbound
    ${fwcmd} add 240 allow icmp from any to any icmptypes 8 out \{ xmit "$int_if" or xmit "$tun_if" or xmit "$nat_if" \} record-state
    ${fwcmd} add 241 allow icmp from any to any out \{ xmit "$int_if" or xmit "$tun_if" or xmit "$nat_if" \}
    if [ "$ipv6_available" -eq 1 ]; then
        # Allow all ICMPv6 outbound
        ${fwcmd} add 242 allow ipv6-icmp from any to any icmp6types 128 out \{ xmit "$int_if" or xmit "$tun_if" or xmit "$nat_if" \} record-state
        ${fwcmd} add 243 allow ipv6-icmp from any to any out \{ xmit "$int_if" or xmit "$tun_if" or xmit "$nat_if" \}
    fi

    # Allow all outbound traffic with stateful handling
    ${fwcmd} add 244 allow ip from any to any out \{ xmit "$int_if" or xmit "$tun_if" or xmit "$nat_if" \} record-state
elif [ "$int_if_available" -eq 1 ] && [ "$tun_if_available" -eq 1 ]; then
    # Allow all ICMPv4 outbound
    ${fwcmd} add 240 allow icmp from any to any icmptypes 8 out \{ xmit "$int_if" or xmit "$tun_if" \} record-state
    ${fwcmd} add 241 allow icmp from any to any out \{ xmit "$int_if" or xmit "$tun_if" \}
    if [ "$ipv6_available" -eq 1 ]; then
        # Allow all ICMPv6 outbound
        ${fwcmd} add 242 allow ipv6-icmp from any to any icmp6types 128 out \{ xmit "$int_if" or xmit "$tun_if" \} record-state
        ${fwcmd} add 243 allow ipv6-icmp from any to any out \{ xmit "$int_if" or xmit "$tun_if" \}
    fi

    # Allow all outbound traffic with stateful handling
    ${fwcmd} add 244 allow ip from any to any out \{ xmit "$int_if" or xmit "$tun_if" \} record-state
else
    # Allow all ICMPv4 outbound
    ${fwcmd} add 240 allow icmp from any to any icmptypes 8 out record-state
    ${fwcmd} add 241 allow icmp from any to any out
    if [ "$ipv6_available" -eq 1 ]; then
        # Allow all ICMPv6 outbound
        ${fwcmd} add 242 allow ipv6-icmp from any to any icmp6types 128 out record-state
        ${fwcmd} add 243 allow ipv6-icmp from any to any out
    fi

    # Allow all outbound traffic with stateful handling
    ${fwcmd} add 244 allow ip from any to any out record-state
fi

#################################
# Block Banned and Spoofed IPs
#################################
# Anti-spoofing: Deny traffic with invalid source addresses
${fwcmd} add 250 deny ip from any to any not verrevpath in

#################################
# ICMP Rules for Network Functionality
#################################
# Allow ICMPv4 Echo Reply, Destination Unreachable, Echo Request, and Time Exceeded
${fwcmd} add 260 allow icmp from any to any icmptypes 0,3,8,11 in

# Allow ICMPv6 Destination Unreachable, Packet Too Big, Time Exceeded, Echo Request/Reply, and RA
if [ "$ipv6_available" -eq 1 ]; then
    ${fwcmd} add 261 allow ipv6-icmp from any to any icmp6types 1,2,3,128,129,133,134 in
fi

# Deny all other ICMPv4 and ICMPv6 traffic
${fwcmd} add 262 deny log icmp from any to any in
if [ "$ipv6_available" -eq 1 ]; then
    ${fwcmd} add 263 deny log ipv6-icmp from any to any in
fi

#################################
# Block Martians and Multicast Traffic
#################################
# Block inbound multicast traffic
if [ -n "${multicast_ip4:-}" ] && [ "$multicast_ip4" != "none" ]; then
    ${fwcmd} add 270 deny ip from "$multicast_ip4" to any in
    ${fwcmd} add 271 deny ip from any to "$multicast_ip4" in
fi
if [ -n "${multicast_ip6:-}" ] && [ "$multicast_ip6" != "none" ] && [ "$ipv6_available" -eq 1 ]; then
    ${fwcmd} add 272 deny ip from "$multicast_ip6" to any in
    ${fwcmd} add 273 deny ip from any to "$multicast_ip6" in
fi

# Block martian IP ranges
if [ -n "${martians_ip4:-}" ] && [ "$martians_ip4" != "none" ]; then
    ${fwcmd} add 274 deny ip from "$martians_ip4" to any in
    ${fwcmd} add 275 deny ip from any to "$martians_ip4" in
fi
if [ -n "${martians_ip6:-}" ] && [ "$martians_ip6" != "none" ] &&
    [ -n "${martians_ip6_2:-}" ] && [ "$martians_ip6_2" != "none" ] && [ "$ipv6_available" -eq 1 ]; then
    ${fwcmd} add 276 deny ip from "$martians_ip6" to any in
    ${fwcmd} add 277 deny ip from any to "$martians_ip6" in
    ${fwcmd} add 278 deny ip from "$martians_ip6_2" to any in
    ${fwcmd} add 279 deny ip from any to "$martians_ip6_2" in
fi

#################################
# Inbound Traffic (User-Defined Services)
#################################
# Allow new SSH connections from allowed source IPs to the firewall
if [ -n "${ssh_ip4:-}" ] && [ "$ssh_ip4" != "none" ] && [ -n "${ssh_tcp_port:-}" ] && [ "$ssh_tcp_port" != "none" ]; then
    ${fwcmd} add 300 count log ip4 from "$ssh_ip4" to me "$ssh_tcp_port" tcpflags syn,!ack,!fin,!rst in
    ${fwcmd} add 301 allow ip4 from "$ssh_ip4" to me "$ssh_tcp_port" tcpflags syn,!ack,!fin,!rst in limit dst-addr 2
fi

# Allow user connections to the firewall, with source IP limit for DoS mitigation
if [ -n "${lan_tcp_ports:-}" ] && [ "$lan_tcp_ports" != "none" ] && [ "$int_if_available" -eq 1 ]; then
    ${fwcmd} add 302 allow ip4 from any to me "$lan_tcp_ports" tcpflags syn,!ack,!fin,!rst in recv "$int_if" record-state
fi
if [ -n "${lan_udp_ports:-}" ] && [ "$lan_udp_ports" != "none" ] && [ "$int_if_available" -eq 1 ]; then
    ${fwcmd} add 303 allow ip4 from any to me "$lan_udp_ports" proto udp in recv "$int_if" record-state
fi
if [ -n "${wan_tcp_ports:-}" ] && [ "$wan_tcp_ports" != "none" ]; then
    ${fwcmd} add 304 count log ip4 from any to me "$wan_tcp_ports" tcpflags syn,!ack,!fin,!rst in
    ${fwcmd} add 305 allow ip4 from any to me "$wan_tcp_ports" tcpflags syn,!ack,!fin,!rst in limit src-addr 10
fi
if [ -n "${wan_udp_ports:-}" ] && [ "$wan_udp_ports" != "none" ]; then
    ${fwcmd} add 306 allow ip4 from any to me "$wan_udp_ports" proto udp in limit src-addr 10
fi

# IPv6 SSH and user rules (if IPv6 is available)
if [ "$ipv6_available" -eq 1 ]; then
    if [ -n "${ssh_ip6:-}" ] && [ "$ssh_ip6" != "none" ] && [ -n "${ssh_tcp_port:-}" ] && [ "$ssh_tcp_port" != "none" ]; then
        ${fwcmd} add 310 count log ip6 from "$ssh_ip6" to me6 "$ssh_tcp_port" tcpflags syn,!ack,!fin,!rst in
        ${fwcmd} add 311 allow ip6 from "$ssh_ip6" to me6 "$ssh_tcp_port" tcpflags syn,!ack,!fin,!rst in limit dst-addr 2
    fi
    if [ -n "${lan_tcp_ports:-}" ] && [ "$lan_tcp_ports" != "none" ] && [ "$int_if_available" -eq 1 ]; then
        ${fwcmd} add 312 allow ip6 from any to me6 "$lan_tcp_ports" tcpflags syn,!ack,!fin,!rst in recv "$int_if" record-state
    fi
    if [ -n "${lan_udp_ports:-}" ] && [ "$lan_udp_ports" != "none" ] && [ "$int_if_available" -eq 1 ]; then
        ${fwcmd} add 313 allow ip6 from any to me6 "$lan_udp_ports" proto udp in recv "$int_if" record-state
    fi
    if [ -n "${wan_tcp_ports:-}" ] && [ "$wan_tcp_ports" != "none" ]; then
        ${fwcmd} add 314 count log ip6 from any to me6 "$wan_tcp_ports" tcpflags syn,!ack,!fin,!rst in
        ${fwcmd} add 315 allow ip6 from any to me6 "$wan_tcp_ports" tcpflags syn,!ack,!fin,!rst in limit src-addr 10
    fi
    if [ -n "${wan_udp_ports:-}" ] && [ "$wan_udp_ports" != "none" ]; then
        ${fwcmd} add 316 allow ip6 from any to me6 "$wan_udp_ports" proto udp in limit src-addr 10
    fi
fi

#################################
# Inbound Internal Traffic
#################################
# Deny any inbound traffic to me that hasn't been explicitly allowed
if [ "$log_default_deny" = "yes" ]; then
    ${fwcmd} add 320 deny log ip from any to me in
    if [ "$ipv6_available" -eq 1 ]; then
        ${fwcmd} add 321 deny log ip from any to me6 in
    fi
else
    ${fwcmd} add 320 deny ip from any to me in
    if [ "$ipv6_available" -eq 1 ]; then
        ${fwcmd} add 321 deny ip from any to me6 in
    fi
fi

# Allow all traffic passing through the internal bridge interface (if available)
if [ "$int_if_available" -eq 1 ]; then
    ${fwcmd} add 322 allow ip from any to any tcpflags syn,!ack,!fin,!rst in recv "$int_if" record-state
    ${fwcmd} add 323 allow \{ udp or igmp \} from any to any in recv "$int_if" record-state
fi

#################################
# Final Rule: Deny all other traffic
#################################
# Deny any traffic that hasn't been explicitly allowed
if [ "$log_default_deny" = "yes" ]; then
    ${fwcmd} add 390 deny log ip from any to any
else
    ${fwcmd} add 390 deny ip from any to any
fi
